#!/bin/sh

tempBackupName=$VS_DATA_PATH/Backups/latest.vcbds

checkBackupStatus()
{
  backupSizeStart=$(stat --printf="%s" $tempBackupName)
  sleep 5
  backupSizeEnd=$(stat --printf="%s" $tempBackupName)
  if [ $backupSizeStart < $backupSizeEnd ]; then
      return 1
  fi
  return 0;
}

echo "Start prepared backup server..."

bash vs_server command genbackup latest.vcbds

echo "Avaiting backup..."

res=1
while [ $res > 0 ]
do
  res=$(checkBackupStatus)
done

echo "Compress backup file..."

currentDate=$(date +$VS_BACKUPS_DATE_FORMAT)
archiveName="vs_server_backup_${currentDate}.tar.gz"
tar -zcvf $VS_DATA_PATH/Backups/$archiveName $tempBackupName

echo "Cleanup old backups"

find $VS_DATA_PATH/Backups -type f -mtime +$VS_BACKUPS_AGE_LIMIT -print0 | xargs -0 rm -f

echo "Cleanup latest backup temp file"

rm -f $tempBackupName

echo "Successfully backuped"
